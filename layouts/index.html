{{ define "main" }}
{{- $photos := slice -}}
{{- $photoFiles := readDir "static/photos" -}}
{{- range $photoFiles -}}
  {{- if strings.HasSuffix .Name ".yaml" -}}
    {{- $baseName := replaceRE "\\.yaml$" "" .Name -}}
    {{- $yamlPath := printf "static/photos/%s" .Name -}}
    {{- $meta := readFile $yamlPath | transform.Unmarshal -}}
    {{/* Use url from YAML if present, otherwise fall back to local path */}}
    {{- $src := "" -}}
    {{- if $meta.url -}}
      {{- $src = $meta.url -}}
    {{- else -}}
      {{/* Try to find local image file */}}
      {{- $extensions := slice ".jpg" ".jpeg" ".png" ".webp" -}}
      {{- range $extensions -}}
        {{- $imgPath := printf "static/photos/%s%s" $baseName . -}}
        {{- if fileExists $imgPath -}}
          {{- $src = printf "/photos/%s%s" $baseName . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $src -}}
      {{- $photo := dict "file" .Name "src" $src "caption" (default $baseName $meta.caption) "date" (default "" $meta.date) "location" (default "" $meta.location) "tags" (default slice $meta.tags) -}}
      {{- $photos = $photos | append $photo -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $sortedPhotos := sort $photos "date" "desc" -}}

{{/* Collect all unique tags */}}
{{- $allTags := slice -}}
{{- range $sortedPhotos -}}
  {{- range .tags -}}
    {{- if not (in $allTags .) -}}
      {{- $allTags = $allTags | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $allTags = sort $allTags -}}

{{/* Tag Filter Bar - Grouped by Category */}}
{{ if gt (len $allTags) 0 }}
<div class="tag-filters">
  {{- $categories := site.Data.tagcategories.categories -}}
  {{- $usedTags := slice -}}
  {{- range $categories }}
    {{- $categoryTags := slice -}}
    {{- range .tags }}
      {{- if in $allTags . }}
        {{- $categoryTags = $categoryTags | append . }}
        {{- $usedTags = $usedTags | append . }}
      {{- end }}
    {{- end }}
    {{- $categoryTags = sort $categoryTags -}}
    {{- if gt (len $categoryTags) 0 }}
  <div class="tag-group">
    <button class="tag-group-label" aria-expanded="false">{{ .name }}</button>
    <div class="tag-group-tags collapsed">
      {{- range $categoryTags }}
      <button class="tag-filter" data-tag="{{ . }}">{{ . }}</button>
      {{- end }}
    </div>
  </div>
    {{- end }}
  {{- end }}
  {{/* Show uncategorized tags if any */}}
  {{- $uncategorized := slice -}}
  {{- range $allTags }}
    {{- if not (in $usedTags .) }}
      {{- $uncategorized = $uncategorized | append . }}
    {{- end }}
  {{- end }}
  {{- $uncategorized = sort $uncategorized -}}
  {{- if gt (len $uncategorized) 0 }}
  <div class="tag-group">
    <button class="tag-group-label" aria-expanded="false">Other</button>
    <div class="tag-group-tags collapsed">
      {{- range $uncategorized }}
      <button class="tag-filter" data-tag="{{ . }}">{{ . }}</button>
      {{- end }}
    </div>
  </div>
  {{- end }}
</div>
{{ end }}

{{/* Photo Grid */}}
<div class="photo-grid">
  {{- range $sortedPhotos }}
  <div class="photo-card" data-tags="{{ delimit .tags "," }}" data-src="{{ .src }}" data-caption="{{ .caption }}" data-date="{{ .date }}" data-location="{{ .location }}">
    <img src="{{ .src }}" alt="{{ .caption }}" loading="lazy">
    <div class="caption">{{ .caption }}</div>
    <div class="meta">
      {{- if .date }}{{ .date }}{{ end }}
      {{- if and .date .location }} Â· {{ end }}
      {{- if .location }}{{ .location }}{{ end }}
    </div>
    {{ if .tags }}
    <div class="tags">
      {{- range .tags }}
      <span class="tag">{{ . }}</span>
      {{- end }}
    </div>
    {{ end }}
  </div>
  {{- end }}
</div>

{{/* Lightbox */}}
<div class="lightbox" id="lightbox">
  <button class="close" aria-label="Close">&times;</button>
  <button class="nav prev" aria-label="Previous">&lsaquo;</button>
  <button class="nav next" aria-label="Next">&rsaquo;</button>
  <img src="" alt="">
  <div class="lightbox-caption">
    <div class="caption"></div>
    <div class="meta"></div>
  </div>
</div>
{{ end }}
