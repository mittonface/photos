{{ define "main" }}
{{- $photos := slice -}}
{{- $photoFiles := readDir "static/photos" -}}
{{- range $photoFiles -}}
  {{- if strings.HasSuffix .Name ".yaml" -}}
    {{- $baseName := replaceRE "\\.yaml$" "" .Name -}}
    {{- $yamlPath := printf "static/photos/%s" .Name -}}
    {{- $meta := readFile $yamlPath | transform.Unmarshal -}}
    {{/* Use url from YAML if present, otherwise fall back to local path */}}
    {{- $src := "" -}}
    {{- if $meta.url -}}
      {{- $src = $meta.url -}}
    {{- else -}}
      {{/* Try to find local image file */}}
      {{- $extensions := slice ".jpg" ".jpeg" ".png" ".webp" -}}
      {{- range $extensions -}}
        {{- $imgPath := printf "static/photos/%s%s" $baseName . -}}
        {{- if fileExists $imgPath -}}
          {{- $src = printf "/photos/%s%s" $baseName . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $src -}}
      {{- $thumbnail := default $src $meta.thumbnail_url -}}
      {{- $photo := dict "file" .Name "src" $src "thumbnail" $thumbnail "caption" (default $baseName $meta.caption) "date" (default "" $meta.date) "location" (default "" $meta.location) "tags" (default slice $meta.tags) "thumbnail_width" (default 0 $meta.thumbnail_width) "thumbnail_height" (default 0 $meta.thumbnail_height) -}}
      {{- $photos = $photos | append $photo -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $sortedPhotos := sort $photos "date" "desc" -}}

{{/* Collect all unique tags */}}
{{- $allTags := slice -}}
{{- range $sortedPhotos -}}
  {{- range .tags -}}
    {{- if not (in $allTags .) -}}
      {{- $allTags = $allTags | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $allTags = sort $allTags -}}

{{/* Tag Filter Bar - Grouped by Category */}}
{{ if gt (len $allTags) 0 }}
<div class="tag-filters">
  {{- $categories := site.Data.tagcategories.categories -}}
  {{- $usedTags := slice -}}
  {{- range $categories }}
    {{- $categoryTags := slice -}}
    {{- range .tags }}
      {{- if in $allTags . }}
        {{- $categoryTags = $categoryTags | append . }}
        {{- $usedTags = $usedTags | append . }}
      {{- end }}
    {{- end }}
    {{- $categoryTags = sort $categoryTags -}}
    {{- if gt (len $categoryTags) 0 }}
  <div class="tag-group">
    <button class="tag-group-label" aria-expanded="false">{{ .name }}</button>
    <div class="tag-group-tags collapsed">
      {{- range $categoryTags }}
      <button class="tag-filter" data-tag="{{ . }}" aria-pressed="false">{{ . }}</button>
      {{- end }}
    </div>
  </div>
    {{- end }}
  {{- end }}
  {{/* Show uncategorized tags if any */}}
  {{- $uncategorized := slice -}}
  {{- range $allTags }}
    {{- if not (in $usedTags .) }}
      {{- $uncategorized = $uncategorized | append . }}
    {{- end }}
  {{- end }}
  {{- $uncategorized = sort $uncategorized -}}
  {{- if gt (len $uncategorized) 0 }}
  <div class="tag-group">
    <button class="tag-group-label" aria-expanded="false">Other</button>
    <div class="tag-group-tags collapsed">
      {{- range $uncategorized }}
      <button class="tag-filter" data-tag="{{ . }}" aria-pressed="false">{{ . }}</button>
      {{- end }}
    </div>
  </div>
  {{- end }}
</div>
{{ end }}

{{/* Photo Grid */}}
<div class="photo-grid">
  {{- range $index, $photo := $sortedPhotos }}
  <div class="photo-card" role="button" tabindex="0" aria-label="View photo: {{ $photo.caption }}" data-tags="{{ delimit $photo.tags "," }}" data-src="{{ $photo.src }}" data-caption="{{ $photo.caption }}" data-date="{{ $photo.date }}" data-location="{{ $photo.location }}">
    <img src="{{ $photo.thumbnail }}" alt="{{ $photo.caption }}" {{ if and $photo.thumbnail_width $photo.thumbnail_height }}style="aspect-ratio: {{ $photo.thumbnail_width }}/{{ $photo.thumbnail_height }}" {{ end }}{{ if gt $index 5 }}loading="lazy" {{ end }}decoding="async">
    <div class="caption">{{ $photo.caption }}</div>
    <div class="meta">
      {{- if $photo.date }}{{ $photo.date }}{{ end }}
      {{- if and $photo.date $photo.location }} Â· {{ end }}
      {{- if $photo.location }}{{ $photo.location }}{{ end }}
    </div>
    {{ if $photo.tags }}
    <div class="tags">
      {{- range $photo.tags }}
      <span class="tag">{{ . }}</span>
      {{- end }}
    </div>
    {{ end }}
  </div>
  {{- end }}
</div>

{{/* Lightbox */}}
<div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Photo viewer" aria-hidden="true">
  <div class="sr-only" aria-live="polite" id="lightbox-announce"></div>
  <button class="close" aria-label="Close lightbox" tabindex="-1">&times;</button>
  <button class="nav prev" aria-label="Previous photo" tabindex="-1">&lsaquo;</button>
  <button class="nav next" aria-label="Next photo" tabindex="-1">&rsaquo;</button>
  <img src="" alt="">
  <div class="lightbox-caption">
    <div class="caption"></div>
    <div class="meta"></div>
  </div>
</div>
{{ end }}
